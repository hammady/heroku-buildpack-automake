#!/usr/bin/env bash
# bin/compile BUILD_DIR CACHE_DIR

BUILD_DIR=$1
CACHE_DIR=$2

indent() {
  sed 's/^/       /'
}

arrow() {
  echo; echo "-----> $1"
}

die() {
  echo; echo "!     $1"
  exit 1
}

cd $BUILD_DIR

if [[ -f MMakefile ]]
then
  cat MMakefile | while read dirspec; do
    # getting subdir param and validating it
    subdir=`echo $dirspec | cut -d: -f1`
    config=`echo $dirspec | cut -d: -f2`
    [ "$subdir" == "$config" ] && config=
    [ -d "$subdir" ] || die "Subdirectory $subdir does not exist, please fix your MMakefile, aborting"
    cd "$BUILD_DIR/$subdir"

    # configuring
    if [ -f configure ]; then
      arrow "Configuring in $subdir..."
      ./configure $config 2>&1 || die "Error configuring in $subdir, aborting"
      arrow "Configuration succeeded in $subdir"
    fi

    # making
    arrow "Making in $subdir..."
    make 2>&1 || die "Compilation failed in $subdir, aborting"
    arrow "Compliation succeeded in $subdir"
  done
fi

exit 0
